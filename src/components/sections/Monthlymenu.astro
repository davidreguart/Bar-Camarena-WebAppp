---
// Importa el JSON
import dishes from "../../../data/dishes.json";
import {
  getCurrentDay,
  isDateToday,
  getFirstDayWeekIndex,
  getCalendarSlots,
  getDaysInCurrentMonth,
} from "../../utils/dateUtils";

// Date logic extracted to utils
const currentDay = getCurrentDay();
const firstDayWeekIndex = getFirstDayWeekIndex();
const daysInMonth = getDaysInCurrentMonth();
const calendarSlots = getCalendarSlots(firstDayWeekIndex, daysInMonth);

const getDishesForDay = (dayIndex: number) => {
  if (dayIndex < firstDayWeekIndex) return null;
  const day = dayIndex - firstDayWeekIndex + 1;
  const daysDishes = dishes[day] || ["-", "-", "-", "-"];
  const isTransparent = daysDishes.every((dish) => dish === "-");
  return { day, dishes: daysDishes, isTransparent };
};

// Días de la semana, comenzando por lunes
const daysOfWeekList = [
  "Lunes",
  "Martes",
  "Miércoles",
  "Jueves",
  "Viernes",
  "Sábado",
  "Domingo",
];
---

<section id="menu" class="w-11/12 md:w-3/4 m-auto">
  <h2 class="text-4xl text-negro font-bold text-center mb-8">
    Menú <span class="text-rojo">diario</span>
  </h2>
  <p class="w-3/4 mx-auto text-lg text-center mb-8">
    Aquí podrás encontrar los 4 platos que vamos a preparar para cada día de
    este mes, son distintos todos los días y puedes venir a probarlos a nuestro
    local o recogerlos para llevar.
  </p>

  <!-- Slider para móviles -->
  <div
    id="mobile-slider"
    class="block md:hidden overflow-x-auto whitespace-nowrap scroll-smooth"
  >
    {
      calendarSlots.map((i) => {
        const data = getDishesForDay(i);

        if (!data) {
          // Empty slot
          return (
            <div class="inline-block text-center border-2 border-transparent rounded-xl p-4 w-52 m-2">
              {/* Tarjeta vacía */}
            </div>
          );
        }

        const { day, dishes: dishesForDay, isTransparent } = data;
        const isToday = isDateToday(day);
        
        // Logic: 
        // - If Today and Open -> bg-amarillo
        // - If Closed (isTransparent) -> transparent-card (Red)
        // - If Today and Closed -> transparent-card (Red) - Priority to Closed color as requested, or keep red. 
        // User said: "exception: if it is a day the restaurant is closed, in that case it must maintain the red."
        
        let cardClass = "bg-blanco"; // Default
        if (isTransparent) {
             cardClass = "transparent-card"; // Closed/Red
        } else if (isToday) {
             cardClass = "bg-amarillo"; // Today Open
        }

        const dayOfWeek = daysOfWeekList[i % 7];

        return (
          <div
            id={`dayCard-mobile-${day}`}
            data-day={day}
            data-is-closed={isTransparent}
            class={`day-card inline-block text-center border-2 border-negro rounded-xl p-4 w-52 m-2 ${cardClass}`}
          >
            <h3 class="text-xl font-bold mb-2">{day}</h3>
            <p class="text-sm font-medium mb-1">{dayOfWeek}</p>
            <hr class="w-4/5 h-[1px] mx-auto my-2 bg-negro border-0 rounded-full" />
            <ul class="text-sm">
              {dishesForDay.map((dish) => (
                <li>{dish}</li>
              ))}
            </ul>
          </div>
        );
      })
    }
  </div>

  <!-- Diseño de cuadrícula para resoluciones mayores -->
  <div class="hidden md:grid grid-cols-7 gap-4">
    {
      calendarSlots.map((i) => {
        const data = getDishesForDay(i);

        if (!data) {
          return (
            <div class="bg-blanco text-center border-2 border-negro rounded-xl p-2">
              {/* Tarjeta vacía */}
            </div>
          );
        }

        const { day, dishes: dishesForDay, isTransparent } = data;
        const isToday = isDateToday(day);
        
        let cardClass = "bg-blanco"; 
        if (isTransparent) {
             cardClass = "transparent-card"; 
        } else if (isToday) {
             cardClass = "bg-amarillo";
        }

        const dayOfWeek = daysOfWeekList[i % 7];

        return (
          <div
            id={`dayCard-desktop-${day}`}
            data-day={day}
            data-is-closed={isTransparent}
            class={`day-card text-center border-2 border-negro rounded-xl p-2 ${cardClass}`}
          >
            <h3 class="text-xl font-bold mb-2">
              {dayOfWeek} {day}
            </h3>
            <hr class="w-4/5 h-[1.5px] mx-auto my-2 bg-negro border-0 rounded-full" />
            <ul class="text-sm font-regular">
              {dishesForDay.map((dish) => (
                <li>{dish}</li>
              ))}
            </ul>
          </div>
        );
      })
    }
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const currentDay = new Date().getDate();
    
    // Dynamic highlighting logic
    const allCards = document.querySelectorAll('.day-card');
    allCards.forEach(card => {
      const cardDay = parseInt(card.getAttribute('data-day') || '0');
      const isClosed = card.getAttribute('data-is-closed') === 'true';
      
      if (cardDay === currentDay) {
        if (!isClosed) {
          card.classList.add('bg-amarillo');
          card.classList.remove('bg-blanco');
        }
      } else {
        // Remove highlighting from other cards (in case they were highlighted at build time)
        if (!isClosed) {
          card.classList.remove('bg-amarillo');
          card.classList.add('bg-blanco');
        }
      }
    });

    // Scrolling logic for mobile
    const mobileDayCardId = `dayCard-mobile-${currentDay}`;
    const dayCard = document.getElementById(mobileDayCardId);
    const slider = document.getElementById("mobile-slider");

    if (dayCard && slider) {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const sliderWidth = slider.clientWidth;
            const cardWidth = dayCard.offsetWidth;
            const cardOffset = dayCard.offsetLeft;
            const scrollPosition = cardOffset - sliderWidth / 2 + cardWidth / 2;

            slider.scrollTo({ left: scrollPosition, behavior: "smooth" });
            dayCard.classList.add("scale-105");
            observer.unobserve(slider);
          }
        });
      });

      observer.observe(slider);
    }
  });
</script>

<style>
  .transparent-card {
    background-color: rgba(234, 88, 87, 0.5); /* Rojo con opacidad */
    border-color: black;
  }
  /* bg-amarillo is handled by Tailwind util, removing override */
</style>
